# 문제점 및 개선 사항

## 1. 데이터 품질 이슈

### 1.1 담보명(coverage_name) 데이터 오염

**발견 일시**: 2025-12-11

**문제 상황**:
DB의 `coverage` 테이블에 잘못된 담보명이 포함되어 있음

**구체적인 예시**:
```
119 뇌졸중진단비
121 뇌출혈진단비
10년
15년
[갱신형]가족 일상생활중 배상책임Ⅱ
```

**문제 유형**:
1. **조항 번호가 담보명으로 저장됨**: "119", "121" 등
2. **기간 정보가 담보명으로 저장됨**: "10년", "15년" 등
3. **너무 짧은 담보명**: 3자 미만의 의미 없는 데이터
4. **형식 불일치**: 일부는 "[갱신형]" 접두사 포함, 일부는 미포함

**영향 범위**:
- `/api/companies/{company_name}/coverages` API
- InfoQueryBuilder 담보 선택 UI
- 사용자 경험 저하 (무의미한 담보명 표시)

**임시 해결책** (2025-12-11 적용):
`api/server.py`의 `get_company_coverages()` 함수에 필터링 로직 추가
```python
# 잘못된 데이터 필터링
# 1. 숫자로만 구성된 담보명 제외
# 2. "10년", "15년" 같은 기간 데이터 제외
# 3. 너무 짧은 담보명 제외 (3자 미만)
if not coverage_name or len(coverage_name.strip()) < 3:
    continue

coverage_stripped = coverage_name.strip()

# 숫자로 시작하는 경우 (조항 번호 등)
if coverage_stripped[0].isdigit():
    # "10년형" 같은 기간 데이터 제외
    if "년" in coverage_stripped and len(coverage_stripped) <= 4:
        continue
    # "119", "121" 같은 순수 숫자 제외
    if coverage_stripped.split()[0].isdigit():
        continue
```

**근본 해결 방안** (TODO):
1. **데이터 클렌징 스크립트 작성**
   - `coverage` 테이블 전수 조사
   - 잘못된 데이터 패턴 식별
   - 올바른 담보명으로 매핑 또는 삭제

2. **데이터 입력 검증 강화**
   - 원본 데이터 파싱 시 담보명 검증 로직 추가
   - 최소 길이, 형식 규칙 정의
   - 조항 번호와 담보명 분리

3. **DB 스키마 개선 고려**
   ```sql
   ALTER TABLE coverage
   ADD COLUMN clause_number VARCHAR(50),  -- 조항 번호 별도 컬럼
   ADD COLUMN coverage_period VARCHAR(20); -- 기간 정보 별도 컬럼
   ```

4. **데이터 정규화**
   - 담보명 표준화 규칙 수립
   - "[갱신형]", "[비갱신형]" 등은 별도 플래그로 관리

**우선순위**: 중
**담당**: TBD
**예상 작업 시간**: 4-8시간

---

## 2. benefit 테이블 데이터 품질 이슈

**발견 일시**: 2024-12-12
**검증 대상**: benefit 테이블 (보장금액)

### 2.1 요약

| 항목 | 값 |
|------|-----|
| 전체 benefit 레코드 | 357개 |
| 의심 레코드 | 4개 (1.1%) |
| 영향받는 회사 | 현대 (3개), 메리츠 (1개) |
| 수정 가능 여부 | 현대 3개 (올바른 clause 존재) |

### 2.2 Root Cause 분석

**문제 발생 경로**:
```
PDF 파싱 (table_parser.py)
    ↓
현대 가입설계서 내 2개의 다른 테이블 존재:
  - 테이블1: 보장금액 테이블 → 가입금액: 1천만원 ✅
  - 테이블2: 보험료 명세 테이블 → 가입금액: 2,260원 ❌
    ↓
coverage_pipeline.py에서 coverage 생성
  - 담보명 줄바꿈 형태가 테이블2와 일치
  - 테이블2 기준으로 coverage가 생성됨
    ↓
clause_coverage 매핑
  - coverage_name이 일치하는 clause만 매핑
  - 테이블2의 clause만 매핑됨 (잘못된 금액)
    ↓
extract_benefits.py에서 benefit 생성
  - 매핑된 clause에서 금액 추출
  - 1,365원, 2,260원이 benefit_amount로 저장됨 ❌
```

**핵심 원인**:

| 원인 | 설명 |
|------|------|
| PDF 구조 | 동일 담보가 2개 테이블에 중복 존재 (보장금액/보험료명세) |
| 줄바꿈 차이 | 같은 담보명이지만 줄바꿈 위치가 다름 |
| 매칭 로직 | coverage_name 정확 매칭으로 잘못된 clause 선택 |

### 2.3 영향 범위

**회사별 영향**:

| 회사 | 전체 benefit | 의심 케이스 | 비율 |
|------|-------------|------------|------|
| 현대 | 15개 | 3개 | 20.0% |
| 메리츠 | 65개 | 1개 | 1.5% |
| 롯데 | 43개 | 0개 | 0.0% |
| 삼성 | 30개 | 0개 | 0.0% |
| 한화 | 58개 | 0개 | 0.0% |
| 흥국 | 17개 | 0개 | 0.0% |
| DB | 13개 | 0개 | 0.0% |
| KB | 18개 | 0개 | 0.0% |

### 2.4 수정 필요 목록

**현대해상 (수정 완료)** ✅:

| benefit_id | coverage_id | 담보명 | 현재 금액 | 수정 금액 |
|------------|-------------|--------|----------|----------|
| 295 | 124 | 로봇암수술(다빈치)(갑상선/전립선 제외) | 1,365원 | **10,000,000원** |
| 296 | 125 | 로봇암수술(다빈치)(갑상선/전립선) | 2,260원 | **10,000,000원** |
| 294 | 119 | 표적항암약물허가치료 | 13,226원 | **10,000,000원** |

**메리츠 (확인 완료)** ✅:

| benefit_id | coverage_id | 담보명 | 현재 금액 | 비고 |
|------------|-------------|--------|----------|------|
| 236 | 230 | 재활치료 | 10,000원 | 실제 가입금액 1만원 (정상) |

### 2.5 적용된 해결책

**단기 (Workaround)** - 2024-12-12 적용:
1. `api/compare.py`에서 benefit_amount < 100,000원 필터링 추가
2. 수동으로 benefit 테이블 UPDATE (현대 3건)

```sql
-- 현대 다빈치 수술비 수정
UPDATE benefit SET benefit_amount = 10000000
WHERE id IN (295, 296);

-- 현대 표적항암약물허가치료 수정
UPDATE benefit SET benefit_amount = 10000000
WHERE id = 294;
```

### 2.6 재발 방지 대책 (TODO)

1. **coverage_pipeline.py 개선**
   - coverage 생성 시 금액 합리성 검증
   - benefit_amount < 100,000원인 수술/진단비는 제외

2. **table_parser.py 개선**
   - "보험료 명세" 테이블과 "보장금액" 테이블 구분 로직 추가
   - 컬럼 헤더 분석으로 테이블 유형 판별

3. **데이터 검증 스크립트 추가**
   - 정기적인 benefit 금액 검증
   - 이상치 탐지 알림

### 2.7 관련 파일

| 파일 | 역할 |
|------|------|
| `ingestion/table_parser.py` | PDF 테이블 파싱 |
| `ingestion/coverage_pipeline.py` | coverage 레코드 생성 |
| `ingestion/link_clauses.py` | clause_coverage 매핑 |
| `ingestion/extract_benefits.py` | benefit 레코드 생성 |
| `api/compare.py` | 상품 비교 API |

---

## 3. 향후 발견될 문제점

(여기에 새로운 문제점 추가)

---

## 변경 이력

| 일자 | 문제 | 조치 | 담당자 |
|------|------|------|--------|
| 2025-12-11 | 담보명 데이터 오염 | API 레벨 필터링 추가 | Claude |
| 2024-12-12 | benefit 금액 오류 (현대 3건) | DB UPDATE + API 필터링 | Claude |
