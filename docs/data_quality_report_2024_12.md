# 데이터 품질 검증 리포트

**작성일**: 2024-12-12
**검증 대상**: benefit 테이블 (보장금액)

---

## 1. 요약

| 항목 | 값 |
|------|-----|
| 전체 benefit 레코드 | 357개 |
| 의심 레코드 | 4개 (1.1%) |
| 영향받는 회사 | 현대 (3개), 메리츠 (1개) |
| 수정 가능 여부 | 현대 3개 (올바른 clause 존재) |

---

## 2. Root Cause 분석

### 문제 발생 경로

```
PDF 파싱 (table_parser.py)
    ↓
현대 가입설계서 내 2개의 다른 테이블 존재:
  - 테이블1: 보장금액 테이블 → 가입금액: 1천만원 ✅
  - 테이블2: 보험료 명세 테이블 → 가입금액: 2,260원 ❌
    ↓
coverage_pipeline.py에서 coverage 생성  
  - 담보명 줄바꿈 형태가 테이블2와 일치
  - 테이블2 기준으로 coverage가 생성됨
    ↓
clause_coverage 매핑
  - coverage_name이 일치하는 clause만 매핑
  - 테이블2의 clause만 매핑됨 (잘못된 금액)
    ↓
extract_benefits.py에서 benefit 생성
  - 매핑된 clause에서 금액 추출
  - 1,365원, 2,260원이 benefit_amount로 저장됨 ❌
```

### 핵심 원인

| 원인 | 설명 |
|------|------|
| PDF 구조 | 동일 담보가 2개 테이블에 중복 존재 (보장금액/보험료명세) |
| 줄바꿈 차이 | 같은 담보명이지만 줄바꿈 위치가 다름 |
| 매칭 로직 | coverage_name 정확 매칭으로 잘못된 clause 선택 |

---

## 3. 영향 범위

### 회사별 영향

| 회사 | 전체 benefit | 의심 케이스 | 비율 |
|------|-------------|------------|------|
| 현대 | 15개 | 3개 | 20.0% |
| 메리츠 | 65개 | 1개 | 1.5% |
| 롯데 | 43개 | 0개 | 0.0% |
| 삼성 | 30개 | 0개 | 0.0% |
| 한화 | 58개 | 0개 | 0.0% |
| 흥국 | 17개 | 0개 | 0.0% |
| DB | 13개 | 0개 | 0.0% |
| KB | 18개 | 0개 | 0.0% |

### 금액 분포

| 금액 범위 | 레코드 수 |
|----------|---------|
| < 1만원 | 2개 |
| 1-10만원 | 12개 |
| 10-100만원 | 68개 |
| 100만-1천만원 | 91개 |
| 1천만원 이상 | 184개 |

---

## 4. 수정 필요 목록

### 현대해상 (수정 가능)

| benefit_id | coverage_id | 담보명 | 현재 금액 | 수정 금액 |
|------------|-------------|--------|----------|----------|
| 295 | 124 | 로봇암수술(다빈치)(갑상선/전립선 제외) | 1,365원 | **10,000,000원** |
| 296 | 125 | 로봇암수술(다빈치)(갑상선/전립선) | 2,260원 | **10,000,000원** |
| 294 | 119 | 표적항암약물허가치료 | 13,226원 | **10,000,000원** |

**올바른 clause 존재**: clause_id 110797, 110798, 110794

### 메리츠 (확인 필요)

| benefit_id | coverage_id | 담보명 | 현재 금액 | 비고 |
|------------|-------------|--------|----------|------|
| 236 | 230 | 재활치료 | 10,000원 | 실제 금액인지 확인 필요 |

---

## 5. 수정 SQL

```sql
-- 현대 다빈치 수술비 수정
UPDATE benefit SET benefit_amount = 10000000
WHERE id IN (295, 296);

-- 현대 표적항암약물허가치료 수정
UPDATE benefit SET benefit_amount = 10000000
WHERE id = 294;

-- 검증
SELECT b.id, b.benefit_amount, cov.coverage_name
FROM benefit b
JOIN coverage cov ON b.coverage_id = cov.id
WHERE b.id IN (294, 295, 296);
```

---

## 6. 재발 방지 대책

### 단기 (Workaround)

1. `api/compare.py`에서 benefit_amount < 100,000원 필터링 추가
2. 수동으로 benefit 테이블 UPDATE

### 장기 (근본 해결)

1. **coverage_pipeline.py 개선**
   - coverage 생성 시 금액 합리성 검증
   - benefit_amount < 100,000원인 수술/진단비는 제외

2. **table_parser.py 개선**
   - "보험료 명세" 테이블과 "보장금액" 테이블 구분 로직 추가
   - 컬럼 헤더 분석으로 테이블 유형 판별

3. **데이터 검증 스크립트 추가**
   - 정기적인 benefit 금액 검증
   - 이상치 탐지 알림

---

## 7. 관련 파일

| 파일 | 역할 |
|------|------|
| `ingestion/table_parser.py` | PDF 테이블 파싱 |
| `ingestion/coverage_pipeline.py` | coverage 레코드 생성 |
| `ingestion/link_clauses.py` | clause_coverage 매핑 |
| `ingestion/extract_benefits.py` | benefit 레코드 생성 |
| `api/compare.py` | 상품 비교 API |
